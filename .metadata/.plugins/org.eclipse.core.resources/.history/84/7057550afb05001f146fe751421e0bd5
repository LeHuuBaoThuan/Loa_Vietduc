/*
 * handler.c
 *
 *  Created on: Apr 28, 2024
 *      Author: BaoThuan
 */
#include <handler.h>

uint16_t value_MIC[2] = {0};	// Phan tu 0: tuong ung mic doc duoc
								// Phan tu 1: tuong ung che do nhap nhay may giay mode 2
uint16_t thre_MIC = 400;

uint8_t count_mode2 = 1;

ADC_HandleTypeDef* hadc1_fnc;
TIM_HandleTypeDef* htim2_fnc;

MODE_STATUS mode_status = MODE_1;

ADC_ChannelConfTypeDef sConfig = {0};

void init_handler(ADC_HandleTypeDef* hadc, TIM_HandleTypeDef* htim)
{
	htim2_fnc = htim;
	hadc1_fnc = hadc;
}

/**
  * @brief
  * @param
  * @retval
  */
void OFF_ALL(void)
{
	GPIOB->ODR &= ~(GPIO_PIN_5 | GPIO_PIN_6 | GPIO_PIN_7 | GPIO_PIN_8 | GPIO_PIN_9);// reset
}


/**
  * @brief
  * @param
  * @retval
  */
void ON_ALL(void)
{
	GPIOB->ODR |= (GPIO_PIN_5 | GPIO_PIN_6 | GPIO_PIN_7 | GPIO_PIN_8 | GPIO_PIN_9);// set
}

/**
  * @brief
  * @param
  * @retval
  */
HANDLER_STATE Mode1_handl(void)
{
//	HAL_TIM_Base_Stop_IT(htim2_fnc);
	/*CHON VA DOC ADC1 CHN1*/
	sConfig.Channel = ADC_CHANNEL_1;
	sConfig.Rank = 0;
	sConfig.SamplingTime = ADC_SAMPLETIME_239CYCLES_5;

	if (HAL_ADC_ConfigChannel(hadc1_fnc, &sConfig) != HAL_OK)
	{
		return HANDLER_FAIL;
	}

	HAL_ADC_Start(hadc1_fnc);
	HAL_ADC_PollForConversion(hadc1_fnc,1000);
	value_MIC[0] = HAL_ADC_GetValue(hadc1_fnc);

	HAL_ADC_Stop(hadc1_fnc);
	/*SO SANH GIA TRI VA BLINK*/
	if (value_MIC[0] < thre_MIC)
	{
		ON_ALL();
	}
	else
	{
		OFF_ALL();
	}
	return HANDLER_OKE;
}


/**
  * @brief
  * @param
  * @retval
  */
HANDLER_STATE Mode2_handl(void)
{
//	HAL_TIM_Base_Start_IT(htim2_fnc);
	/*CHON VA DOC ADC1 CHN2*/
	sConfig.Channel = ADC_CHANNEL_2;
	sConfig.Rank = 1;
	sConfig.SamplingTime = ADC_SAMPLETIME_239CYCLES_5;

	if (HAL_ADC_ConfigChannel(hadc1_fnc, &sConfig) != HAL_OK)
	{
		return HANDLER_FAIL;
	}

	HAL_ADC_Start(hadc1_fnc);
	HAL_ADC_PollForConversion(hadc1_fnc,1000);
	value_MIC[1] = HAL_ADC_GetValue(hadc1_fnc);

	HAL_ADC_Stop(hadc1_fnc);
	return HANDLER_OKE;
}


/**
  * @brief
  * @param
  * @retval
  */
HANDLER_STATE Handler_Led(void)
{
	if(HAL_GPIO_ReadPin(GPIOB, GPIO_PIN_11) == 0)
	{
		mode_status = MODE_1;
		if(Mode1_handl() != HANDLER_OKE)
			return HANDLER_FAIL;
	}
	else if (HAL_GPIO_ReadPin(GPIOB, GPIO_PIN_11) == 1)
	{
		mode_status = MODE_2;
		if(Mode2_handl() != HANDLER_OKE)
			return HANDLER_FAIL;
	}

	L7D_74HC595_Set_Reset(L7_Kathode[MODE_1], L7_Kathode[count_mode2]);
	return HANDLER_OKE;
}
